name: Private Subnet Deploy (Self-Hosted Runner)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Environment
        run: |
          mkdir -p ./src/main/resources
          echo -e "${{ secrets.APPLICATION }}" > ./src/main/resources/application.yml

      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      - name: Build & Run Docker Container
        run: |
          echo "0. ë¡¤ë°±ì„ ìœ„í•œ ë°±ì—… ì´ë¯¸ì§€ ìƒì„±"
          if docker image inspect new-driveu:latest > /dev/null 2>&1; then
            docker tag new-driveu:latest new-driveu:previous
            echo "âœ… ê¸°ì¡´ ì´ë¯¸ì§€ ë°±ì—… ì™„ë£Œ (new-driveu:previous)"
          else
            echo "â„¹ï¸ ë°±ì—…í•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. (ì²« ë°°í¬ì¸ ê²½ìš°)"
          fi
          
          echo "1. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ"
          docker stop driveu-server || true
          docker rm driveu-server || true
          
          echo "2. ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ (ë¡œì»¬)"
          docker build -t new-driveu:latest .
          
          echo "3. ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
          docker run -d \
            --name driveu-server \
            -p 8080:8080 \
            -m 800m \
            -e TZ=Asia/Seoul \
            -e JAVA_OPTS="-Xms256m -Xmx512m" \
            new-driveu:latest
          
          echo "ğŸ¥ 4. í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° (ìµœëŒ€ 60ì´ˆ)"
          for i in {1..12}; do
            # í—¬ìŠ¤ì²´í¬ ì„±ê³µ ì‹œ
            if curl -s -f http://localhost:8080/actuator/health > /dev/null; then
              echo "âœ… ì»¨í…Œì´ë„ˆ ì •ìƒ êµ¬ë™ í™•ì¸"
              # ì •ìƒ ë°°í¬ë˜ì—ˆìœ¼ë‹ˆ ë°±ì—… ì´ë¯¸ì§€ëŠ” ì‚­ì œ (ìš©ëŸ‰ í™•ë³´)
              docker rmi new-driveu:previous || true
              break
            fi
          
            # í—¬ìŠ¤ì²´í¬ ìµœì¢… ì‹¤íŒ¨ ì‹œ (ë¡¤ë°± ë¡œì§)
            if [ $i -eq 12 ]; then
              echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ë¡¤ë°±(Rollback) ì‹œì‘"
              docker logs driveu-server
          
              # 1. ë§ê°€ì§„ ìƒˆ ì»¨í…Œì´ë„ˆ ì‚­ì œ
              docker stop driveu-server || true
              docker rm driveu-server || true
          
              # 2. ë°±ì—…í•´ë‘” ì´ë¯¸ì§€(previous)ê°€ ìˆëŠ”ì§€ í™•ì¸
              if docker image inspect new-driveu:previous > /dev/null 2>&1; then
                echo "ğŸ”„ ì´ì „ ë²„ì „ìœ¼ë¡œ ë³µêµ¬ ì¤‘..."
                docker run -d \
                  --name driveu-server \
                  -p 8080:8080 \
                  -m 800m \
                  -e TZ=Asia/Seoul \
                  -e JAVA_OPTS="-Xms256m -Xmx512m" \
                  new-driveu:previous
                echo "âœ… ë¡¤ë°± ì™„ë£Œ: ì´ì „ ë²„ì „ìœ¼ë¡œ ì„œë²„ê°€ ì¬ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."
              else
                echo "ğŸš¨ ë¡¤ë°± ì‹¤íŒ¨: ë°±ì—…ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤."
              fi
          
              # íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨ ì²˜ë¦¬
              exit 1
            fi
          
            echo "â³ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘... ($i/12)"
            sleep 5
          done
          
          echo "5. ì“°ë ˆê¸° ì´ë¯¸ì§€ ì •ë¦¬"
          docker image prune -f
